<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>گزارش ماهانه با درصدگیری دستی و خودکار</title>
<style>
  body {
    font-family: Tahoma, sans-serif;
    margin: 0;
    background: #0b1220;
    color: #e5e7eb;
  }
  .wrap { max-width: 1100px; margin: auto; padding: 1rem; }
  h1, h2 { margin: .5rem 0; }
  .card {
    background: #111827;
    border-radius: 12px;
    padding: 1rem;
    margin-top: 1rem;
  }
  label { font-size: .9rem; color: #94a3b8; display: block; margin-bottom: .3rem; }
  input, button {
    width: 100%;
    padding: .6rem;
    border-radius: 8px;
    border: 1px solid #374151;
    background: #0b1526;
    color: #e5e7eb;
  }
  button {
    cursor: pointer;
    background: #1f2937;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: .85rem;
  }
  th, td {
    border-bottom: 1px solid #1f2937;
    padding: .4rem;
    text-align: center;
  }
  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    tr { margin-bottom: .8rem; }
    td { text-align: right; padding-left: 50%; position: relative; }
    td:before {
      position: absolute; left: .5rem; top: .4rem;
      white-space: nowrap;
      color: #94a3b8;
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>گزارش ماهانه (خودکار + درصدگیری دستی)</h1>

  <div class="card">
    <h2>ورود داده روزانه</h2>
    <label>تاریخ (شمسی)</label>
    <input type="date" id="date">
    <label>قرض‌الحسنه جاری</label>
    <input type="number" id="jari">
    <label>قرض‌الحسنه پس‌انداز</label>
    <input type="number" id="pasandaz">
    <label>سرمایه‌گذاری کوتاه‌مدت</label>
    <input type="number" id="kotah">
    <label>سرمایه‌گذاری بلندمدت</label>
    <input type="number" id="boland">
    <button onclick="saveEntry()">ذخیره روز</button>
  </div>

  <div class="card">
    <h2>انتخاب ماه (شمسی)</h2>
    <input type="month" id="monthPicker" onchange="render()">
  </div>

  <div class="card">
    <h2>جدول روزانه</h2>
    <table id="dailyTable">
      <thead>
        <tr>
          <th>تاریخ</th>
          <th>جاری</th><th>%</th>
          <th>پس‌انداز</th><th>%</th>
          <th>کوتاه‌مدت</th><th>%</th>
          <th>بلندمدت</th><th>%</th>
          <th>جمع</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>خلاصه ماهانه (محاسبه خودکار)</h2>
    <div id="autoSummary"></div>
  </div>

  <div class="card">
    <h2>بخش درصدگیری دستی</h2>
    <div>جمع کل: <span id="manualTotal">0</span></div>
    <label>درصد جاری</label>
    <input type="number" id="mpJari" oninput="manualCalc()">
    <label>درصد پس‌انداز</label>
    <input type="number" id="mpPasandaz" oninput="manualCalc()">
    <label>درصد کوتاه‌مدت</label>
    <input type="number" id="mpKotah" oninput="manualCalc()">
    <label>درصد بلندمدت</label>
    <input type="number" id="mpBoland" oninput="manualCalc()">
    <div id="manualResult" style="margin-top:.5rem;color:#a5f3fc"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.6/dist/jalaali.min.js"></script>
<script>
const LS_KEY = "financeReport.v2";

function loadAll() {
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
  catch(e) { return []; }
}
function saveAll(data) {
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}
function saveEntry() {
  const date = document.getElementById('date').value;
  const jari = +document.getElementById('jari').value || 0;
  const pasandaz = +document.getElementById('pasandaz').value || 0;
  const kotah = +document.getElementById('kotah').value || 0;
  const boland = +document.getElementById('boland').value || 0;
  if (!date) { alert('تاریخ را وارد کنید'); return; }
  const all = loadAll();
  const idx = all.findIndex(r => r.date === date);
  const row = {date, jari, pasandaz, kotah, boland};
  if (idx >= 0) all[idx] = row; else all.push(row);
  all.sort((a,b)=>a.date.localeCompare(b.date));
  saveAll(all);
  render();
}
function pct(n, d) { return d>0 ? ((n/d)*100).toFixed(2) : 0; }
function fmt(n) { return n.toLocaleString('fa-IR'); }
function dataForMonth(ym) {
  return loadAll().filter(r => r.date.slice(0,7) === ym);
}
function render() {
  const ym = document.getElementById('monthPicker').value || todayYM();
  document.getElementById('monthPicker').value = ym;
  const rows = dataForMonth(ym);
  const tbody = document.querySelector('#dailyTable tbody');
  tbody.innerHTML = '';
  let sum = {jari:0, pasandaz:0, kotah:0, boland:0, total:0};
  rows.forEach(r => {
    const total = r.jari + r.pasandaz + r.kotah + r.boland;
    sum.jari += r.jari;
    sum.pasandaz += r.pasandaz;
    sum.kotah += r.kotah;
    sum.boland += r.boland;
    sum.total += total;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${toJalali(r.date)}</td>
      <td>${fmt(r.jari)}</td><td>${pct(r.jari,total)}%</td>
      <td>${fmt(r.pasandaz)}</td><td>${pct(r.pasandaz,total)}%</td>
      <td>${fmt(r.kotah)}</td><td>${pct(r.kotah,total)}%</td>
      <td>${fmt(r.boland)}</td><td>${pct(r.boland,total)}%</td>
      <td>${fmt(total)}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('autoSummary').innerHTML = `
    جاری: ${fmt(sum.jari)} (${pct(sum.jari,sum.total)}%)<br>
    پس‌انداز: ${fmt(sum.pasandaz)} (${pct(sum.pasandaz,sum.total)}%)<br>
    کوتاه‌مدت: ${fmt(sum.kotah)} (${pct(sum.kotah,sum.total)}%)<br>
    بلندمدت: ${fmt(sum.boland)} (${pct(sum.boland,sum.total)}%)<br>
    <b>جمع کل: ${fmt(sum.total)}</b>
  `;
  document.getElementById('manualTotal').textContent = fmt(sum.total);
}
function manualCalc() {
  const total = parseFloat(document.getElementById('manualTotal').textContent.replace(/,/g,'')) || 0;
  const pJ = +document.getElementById('mpJari').value || 0;
  const pP = +document.getElementById('mpPasandaz').value || 0;
  const pK = +document.getElementById('mpKotah').value || 0;
  const pB = +document.getElementById('mpBoland').value || 0;
  const sumP = pJ + pP + pK + pB;
  let html = '';
  if (Math.abs(sumP - 100) > 0.01) {
    html += `<span style="color:#f87171">⚠ مجموع درصدها باید ۱۰۰٪ باشد (الان ${sumP}٪)</span><br>`;
  }
  html += `
    جاری: ${fmt((total * pJ/100).toFixed(0))}<br>
    پس‌انداز: ${fmt((total * pP/100).toFixed(0))}<br>
    کوتاه‌مدت: ${fmt((total * pK/100).toFixed(0))}<br>
    بلندمدت: ${fmt((total * pB/100).toFixed(0))}
  `;
  document.getElementById('manualResult').innerHTML = html;
}
function toJalali(isoDate) {
  const [gy, gm, gd] = isoDate.split('-').map(Number);
  const j = jalaali.toJalaali(gy, gm, gd);
  return `${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
}
function todayYM() {
  const d = new Date();
  const j = jalaali.toJalaali(d.getFullYear(), d.getMonth()+1, d.getDate());
  return `${j.jy}-${String(j.jm).padStart(2,'0')}`;
}
window.onload = () => {
  document.getElementById('monthPicker').value = todayYM();
  render();
};
</script>
</body>
</html>
